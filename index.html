<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>–†–∞—Å—Ç–µ–Ω–∏–µ</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = "https://pdveezakbmzdzoaszlye.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkdmVlemFrYm16ZHpvYXN6bHllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMzUxNzQsImV4cCI6MjA3ODcxMTE3NH0.4IAQTx7-xHa-N5361jFqkkKUI3aimC2BJ6XgGr7PYCQ";
  const supabase = window.supabase && window.supabase.createClient ? window.supabase.createClient(supabaseUrl, supabaseKey) : null;
  let currentUser = null;

  async function signInIfNeeded() {
    if(!supabase) return;
    try{
      const { data:{ user } } = await supabase.auth.getUser();
      if (user) { currentUser = user; return; }
      const email = "guest_" + Math.random().toString(36).slice(2) + "@game.com";
      const password = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36);
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (!error) currentUser = data.user;
    }catch(e){ console.warn('supabase signin error', e); }
  }

  async function saveProgressSupabase(state){
    if(!supabase) return;
    if(!currentUser) await signInIfNeeded();
    try{
      await supabase.from('player_progress').upsert({
        user_id: currentUser ? currentUser.id : null,
        money: state.money,
        level: state.level,
        stage: state.stage
      });
    }catch(e){ console.warn('supabase save error', e); }
  }

  async function loadProgressSupabase(){
    if(!supabase) return null;
    if(!currentUser) await signInIfNeeded();
    try{
      const { data } = await supabase.from('player_progress').select('*').eq('user_id', currentUser.id).single();
      if(!data) return null;
      return { money:data.money, level:data.level, stage:data.stage };
    }catch(e){ return null; }
  }
</script>

<style>
  html,body{height:100%;overflow:hidden;touch-action:none;}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;user-select:none;background:#0b0b0b;}
  #game-container{
    width:100%;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:space-between;
    background-size:cover;background-position:center;transition:background-image 1s ease-in-out;position:relative;
  }

  #currency-display{
    position:absolute;top:10px;right:20px;
    background:rgba(0,0,0,0.6);color:#ffd700;border-radius:10px;
    padding:8px 12px;font-weight:bold;z-index:1000;font-size:1.1rem;
    text-shadow:0 0 6px rgba(255,215,0,0.7),0 0 12px rgba(255,215,0,0.4);
  }

  #lamp-toggle{position:absolute;top:60px;right:20px;background:rgba(0,0,0,0.6);color:white;
    border-radius:10px;padding:8px 12px;z-index:1000;cursor:pointer;font-size:1.2rem;transition:background .3s ease;}
  #lamp-toggle:hover{background:rgba(255,255,255,0.25);}
  #fullscreen-toggle{position:absolute;top:110px;right:20px;background:rgba(0,0,0,0.6);color:white;border-radius:10px;padding:8px 12px;z-index:1000;cursor:pointer;font-size:1.2rem;transition:background .3s ease;}
  #fullscreen-toggle:hover{background:rgba(255,255,255,0.25);}

  .exp-bar{position:absolute;top:40px;left:50%;transform:translateX(-50%);
    width:40%;height:24px;background:rgba(255,255,255,0.08);
    border-radius:12px;overflow:hidden;z-index:1000;display:flex;align-items:center;justify-content:center;padding:0 12px;box-sizing:border-box;}
  .exp-fill{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,#4ea8ff,#2a7fff);width:0%;transition:width .35s ease;}
  .exp-text{position:relative;z-index:10;color:gold;font-weight:800;text-shadow:0 0 6px rgba(0,0,0,0.8);font-size:0.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:90%;}
  .progress-bar{width:100%;height:8px;background:rgba(255,255,255,0.06);position:relative;bottom:0;}
  .progress-fill{height:100%;background:limegreen;width:0%;transition:width .5s ease;}

  #plant-area{flex:1;width:100%;display:flex;align-items:flex-end;justify-content:center;padding:24px;box-sizing:border-box;position:relative;}
  #plant-image{transform:scale(1.5) translateY(-40px);max-height:85%;max-width:90%;
    transition:opacity 2s ease-in-out,transform .2s ease-in-out,filter 1s ease;display:block;}
  .glow{filter:drop-shadow(0 0 25px rgba(180,0,255,0.8))drop-shadow(0 0 60px rgba(180,0,255,0.5))drop-shadow(0 0 90px rgba(180,0,255,0.3));}
  .fade-out{opacity:0!important;transition:opacity 2s ease-in-out;}
  .fade-in{opacity:1!important;transition:opacity 2s ease-in-out;}
  .shake{animation:shake .35s;}
  @keyframes shake{
    0%,100%{transform:translate(0,0)rotate(0deg)scale(1.5)translateY(-40px);}
    20%{transform:translate(-4px,2px)rotate(-2deg)scale(1.5)translateY(-40px);}
    40%{transform:translate(4px,-2px)rotate(2deg)scale(1.5)translateY(-40px);}
    60%{transform:translate(-2px,1px)rotate(-1deg)scale(1.5)translateY(-40px);}
    80%{transform:translate(2px,-1px)rotate(1deg)scale(1.5)translateY(-40px);}
  }

  .resources-row{width:100%;padding:16px 24px 28px;box-sizing:border-box;display:flex;justify-content:center;gap:48px;}
  .resource-wrap{position:relative;width:80px;height:100px;display:flex;flex-direction:column;align-items:center;}
  .price-label{font-size:1rem;font-weight:700;color:white;text-shadow:0 0 4px rgba(0,0,0,0.7);margin-bottom:6px;}
  .resource-button{width:80px;height:80px;border:none;background:none;cursor:pointer;position:relative;padding:0;}
  .resource-button img{width:100%;height:100%;object-fit:contain;pointer-events:none;}
  .resource-button:hover{transform:scale(1.05);}
  .resource-button{touch-action:none;-webkit-user-drag:none;user-select:none;cursor:grab;position:relative;}

  .cooldown-ring{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}
  .cooldown-ring circle{fill:none;stroke-width:8;stroke-linecap:round;
    stroke-dasharray:213.6;stroke-dashoffset:213.6;transform:rotate(-90deg);transform-origin:50% 50%;
    transition:stroke-dashoffset linear;
  }

  .coin-popup{position:absolute;left:50%;transform:translateX(-50%);pointer-events:none;font-weight:800;
    color:gold;text-shadow:0 2px 6px rgba(0,0,0,0.6);font-size:1.2rem;}
  .no-money{filter:drop-shadow(0 0 15px red);animation:shake .35s;}
</style>
</head>
<body>
  <div id="game-container">
    <div id="currency-display">$ <span id="money">0</span></div>
    <div id="lamp-toggle">‚òÄÔ∏è</div>
    <div id="fullscreen-toggle">‚õ∂</div>

    <div class="exp-bar"><div id="exp-fill" class="exp-fill"></div><div id="exp-text" class="exp-text">Player ‚Äî 1</div></div>
    <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>

    <div id="plant-area"><img id="plant-image" src="./01.png" alt="–†–∞—Å—Ç–µ–Ω–∏–µ"></div>

    <div class="resources-row">
      <div class="resource-wrap">
        <div class="price-label">50$</div>
        <button id="water-button" class="resource-button">
          <svg class="cooldown-ring" viewBox="0 0 80 80"><circle cx="40" cy="40" r="34" stroke="deepskyblue"></circle></svg>
          <img src="./h2o.png" alt="H2O">
        </button>
      </div>
      <div class="resource-wrap">
        <div class="price-label">150$</div>
        <button id="fertilizer-button" class="resource-button">
          <svg class="cooldown-ring" viewBox="0 0 80 80"><circle cx="40" cy="40" r="34" stroke="limegreen"></circle></svg>
          <img src="./npk.png" alt="NPK">
        </button>
      </div>
      <div class="resource-wrap">
        <div class="price-label">250$</div>
        <button id="co2-button" class="resource-button">
          <svg class="cooldown-ring" viewBox="0 0 80 80"><circle cx="40" cy="40" r="34" stroke="violet"></circle></svg>
          <img src="./co2.png" alt="CO2">
        </button>
      </div>
    </div>
  </div>

<!-- Audio files now expected next to index.html -->
<audio id="sound-h2o" src="h2o.mp3"></audio>
<audio id="sound-npk" src="npk.mp3"></audio>
<audio id="sound-co2" src="co2.mp3"></audio>
<audio id="sound-tap" src="tap.mp3"></audio>
<audio id="sound-no" src="no.mp3"></audio>

<script>
const PLANT_IMAGES = Array.from({length:19},(_,i)=>`./${String(i+1).padStart(2,'0')}.png`);
const BACKGROUNDS = {day:"./day.png", night:"./night.png"};
const PRICES = {water:50, fertilizer:150, co2:250};
const EXP_VALUES = {water:20, fertilizer:50, co2:100};
const COOLDOWNS = {water:5000, fertilizer:10000, co2:20000};

async function initialLoad(){
  const cloud = await loadProgressSupabase();
  if(cloud){
    state.money = cloud.money;
    state.level = cloud.level;
    state.stage = cloud.stage;
  }
  uAll();
}
document.addEventListener('DOMContentLoaded', initialLoad);

let state = JSON.parse(localStorage.getItem("plantGameState")) || {stage:0, level:1, exp:0, expToNext:100, money:0, clickReward:10};
const g=document.getElementById("game-container"), pA=document.getElementById("plant-area"), pI=document.getElementById("plant-image"),
m=document.getElementById("money"), expF=document.getElementById("exp-fill"), progF=document.getElementById("progress-fill"),
expT=document.getElementById("exp-text"), lamp=document.getElementById("lamp-toggle");
let isDay = true;

function toggleBG(){isDay=!isDay;g.style.backgroundImage=`url(${isDay?BACKGROUNDS.day:BACKGROUNDS.night})`;lamp.textContent=isDay?"‚òÄÔ∏è":"üåô";}
g.style.backgroundImage=`url(${BACKGROUNDS.day})`;

function save(){
  localStorage.setItem("plantGameState", JSON.stringify(state));
  saveProgressSupabase(state);
}

function uExp(){
  expF.style.width=`${Math.min(100,(state.exp/state.expToNext)*100)}%`;
  const name = (function(){ try{ return localStorage.getItem('tg_username') || 'Player'; }catch(e){ return 'Player'; } })();
  expT.textContent = `${name} ‚Äî ${state.level}`;
}

function uProg(){progF.style.width=`${(state.stage/(PLANT_IMAGES.length-1))*100}%`;}
function uAll(){pI.src=PLANT_IMAGES[state.stage];m.textContent=state.money;uExp();uProg();}

function addExp(a){
  state.exp += a;
  while(state.exp >= state.expToNext){
    state.exp -= state.expToNext;
    state.level++;
    state.expToNext += 100;

    // –ø–µ—Ä–µ—Ö–æ–¥ —Å—Ç–∞–¥–∏–∏
    state.stage++;
    if(state.stage >= PLANT_IMAGES.length){
      pI.classList.add('fade-out');
      setTimeout(()=>{
        state.stage = 0;
        pI.src = PLANT_IMAGES[state.stage];
        pI.classList.remove('fade-out');
        void pI.offsetWidth;
        pI.classList.add('fade-in');
        setTimeout(()=>{pI.classList.remove('fade-in');uAll();save();},2000);
      },3000);
    }
  }
  uAll(); save();
}

function startCooldown(type){
  const btn=document.getElementById(type+"-button");
  const ring=btn.querySelector(".cooldown-ring circle");
  if(btn.classList.contains("cooling"))return;
  btn.classList.add("cooling"); btn.disabled=true;
  const dur=COOLDOWNS[type];
  ring.style.transition=`stroke-dashoffset ${dur}ms linear`;
  ring.style.strokeDashoffset="0";
  setTimeout(()=>{
    ring.style.transition="none";
    ring.style.strokeDashoffset="213.6";
    btn.classList.remove("cooling"); btn.disabled=false;
  },dur);
}

function useResource(type){
  const btn = document.getElementById(type + '-button');
  if (btn.classList.contains('cooling')) return;
  const cost=PRICES[type];
  if(state.money>=cost){
    state.money-=cost;
    addExp(EXP_VALUES[type]);
    startCooldown(type);
  } else {
    const btnEl=document.getElementById(type+"-button");
    btnEl.classList.add('no-money');
    setTimeout(()=>btnEl.classList.remove('no-money'),400);
    playSound(soundNo);
  }
  save();uAll();
}

pI.onclick = () => {
  playSound(soundTap);
  const a = state.level;
  state.money += a;
  const txt = document.createElement('div');
  txt.className = 'coin-popup';
  txt.textContent = `+${a}$`;
  txt.style.top = '50%';
  pA.appendChild(txt);
  txt.animate(
    [{transform: 'translate(-50%,0)', opacity: 1}, {transform: 'translate(-50%,-60px)', opacity: 0}],
    {duration: 1000, easing: 'ease-out'}
  );
  setTimeout(() => txt.remove(), 1000);
  pI.classList.add('shake', 'glow');
  setTimeout(() => pI.classList.remove('shake'), 350);
  setTimeout(() => pI.classList.remove('glow'), 1000);
  m.textContent = state.money;
  save();
};

lamp.onclick=toggleBG;

const fullscreenBtn = document.getElementById('fullscreen-toggle');
fullscreenBtn.addEventListener('click', () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(err => console.log(err));
  } else {
    document.exitFullscreen();
  }
});

// Drag & drop + touch emulation for resources
['water','fertilizer','co2'].forEach(type => {
  const btn = document.getElementById(type + '-button');
  btn.setAttribute('draggable', true);
  btn.style.cursor = 'grab';

  // –ü–ö drag
  btn.addEventListener('dragstart', e => {
    if (btn.classList.contains('cooling')) { e.preventDefault(); return; }
    e.dataTransfer.setData('text/plain', type);
    btn.style.transform = 'scale(1.5)';
  });
  btn.addEventListener('dragend', () => { btn.style.transform = 'scale(1)'; });

  // touch emulation
  btn.addEventListener('touchstart', e => {
    if (btn.classList.contains('cooling')) { e.preventDefault(); return; }
    e.preventDefault();
    const touch = e.touches[0];
    btn.style.transform = 'scale(1.5)';
    btn.style.position = 'fixed';
    btn.style.zIndex = 2000;

    const moveHandler = moveEv => {
      const t = moveEv.touches[0];
      btn.style.left = (t.clientX - 40) + 'px';
      btn.style.top = (t.clientY - 40) + 'px';
    };

    const endHandler = endEv => {
      btn.style.transform = 'scale(1)';
      btn.style.position = '';
      btn.style.left = '';
      btn.style.top = '';
      btn.style.zIndex = '';

      const t = endEv.changedTouches[0];
      btn.style.visibility = 'hidden';
      const elemBelow = document.elementFromPoint(t.clientX, t.clientY);
      btn.style.visibility = 'visible';

      if (elemBelow && elemBelow.id === 'plant-image') {
        useResource(type);
        switch(type){
          case 'water': playSound(soundH2O); break;
          case 'fertilizer': playSound(soundNPK); break;
          case 'co2': playSound(soundCO2); break;
        }
      }

      window.removeEventListener('touchmove', moveHandler);
      window.removeEventListener('touchend', endHandler);
    };

    window.addEventListener('touchmove', moveHandler, {passive:false});
    window.addEventListener('touchend', endHandler);
  }, {passive:false});
});

// Plant drop handlers
const plant = document.getElementById('plant-image');
plant.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
plant.addEventListener('dragenter', e => { e.preventDefault(); });
plant.addEventListener('dragleave', e => { /* noop */ });
plant.addEventListener('drop', e => {
  e.preventDefault();
  const type = e.dataTransfer.getData('text/plain');
  if(!type) return;
  useResource(type);
  switch(type){
    case 'water': playSound(soundH2O); break;
    case 'fertilizer': playSound(soundNPK); break;
    case 'co2': playSound(soundCO2); break;
  }
});

uAll();
</script>

<script>
const soundH2O = document.getElementById('sound-h2o');
const soundNPK = document.getElementById('sound-npk');
const soundCO2 = document.getElementById('sound-co2');
const soundTap = document.getElementById('sound-tap');
const soundNo = document.getElementById('sound-no');

function playSound(sound) {
  try{
    if(!sound) return;
    sound.currentTime = 0;
    sound.play().catch(()=>{ /* autoplay blocked or missing file */ });
  }catch(e){}
}
</script>
</body>
</html>